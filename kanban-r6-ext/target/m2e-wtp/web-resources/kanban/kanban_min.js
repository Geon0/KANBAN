function CTOpenEditor(b,a){this.parent=b;this.style=a||{};this.callback=this.style.callback;this.url=this.style.url||"usr.ct.edit.jsp?id=";this.className=this.style.className||"CardOpenEditor"}CTOpenEditor.prototype.open=function(d){var e=this;if($(this.parent).find(".CardOpenEditor").length>0){$(this.parent).find(".CardOpenEditor").remove()}var a=$("<div></div>").addClass("CardOpenEditor");a.appendTo(this.parent);a.height(this.parent.height());$("<div>").addClass("CardOpenEditorBg").appendTo(a);this.layerDiv=$("<div>").addClass("cardLayer card-detail").attr("id","CardOpenLayer").appendTo(a);this.layerDiv.data("CTOpenEditor",this);this.layerDiv.data("CTGTitle",d);this.layerDiv.resize(function(f){e.resize()});$(window).resize(function(f){e.resize()});var b=this.url;var c="PORTLET_ID="+CardOpenEditor.CARDOPEN_PTLID+"_"+JSV.SEQUENCE++;setTimeout(function(){e.layerDiv.load(JSV.getContextPath(JSV.getModuleUrl(b),c),function(g,f,h){})},2)};CTOpenEditor.prototype.resize=function(){var a=$(window).width()/2;var b=$(this.layerDiv).width()/2;$(this.layerDiv).css("left",(a-b)+"px");$(this.layerDiv).css("top",$(window).scrollTop()+200)};CTOpenEditor.CARDOPEN_PTLID="CTOPEN";function CardFileViewer(b,a){this.style=a||{};this.className=this.style.className||"CardFileViewer";this.seq=JSV.SEQUENCE++;this.fileSeqId=1;this.fileCount=0;this.xhrObjs={};this.count=0;this.ptlId=this.style.ptlId;this.dataName="data.attachments";this.cardId=JSV.getParameter("id",this.ptlId)||this.style.cardId;this.attachUrl=this.style.attach;this.registerUrl=this.style.register;this.removeUrl=this.style.remove;this.add=this.style.add||JSV.getLang("CardFileViewer","fileAdd");this.parentWidget=$("<div></div>").appendTo(b).addClass("CardFile");this.widget=$('<div>			<div class="title"></div>	</div>').addClass(this.className).appendTo(this.parentWidget);var d=$("<div>").addClass("hide").appendTo(this.widget);this.ul=$("<ul>").addClass("file_list").appendTo(this.widget);var c=new KButton(this.widget.find("div.title"),{text:this.add,className:"H24"});c.comp=this;c.onclick=function(){CardFileViewer.component=this.comp;var e;if(this.comp.widget.find("div.title >  input[type=file]").length>0){e=this.comp.widget.find("div.title >  input[type=file]")}else{e=$("<input>").attr({type:"file",multiple:"multiple"}).appendTo(this.comp.widget.find("div.title")).hide().change(function(f){CardFileViewer.component.selectHandler(f.target.files)}).click(function(f){f.stopPropagation()})}e.val("").click()};JQueryUI.load($.proxy(this,"initDialog"))}CardFileViewer.prototype.setValue=function(c){var b=this.ul;$(b).empty();if(c&&c.length>0){for(var a=0;a<c.length;a++){this.createFile(b,c[a],a)}}};CardFileViewer.prototype.createFile=function(parent,value,index){var $this=this;var li=$("<li>").addClass("file_item").appendTo(parent);$("<img>").addClass("fileIcon").attr("src",JSV.getContextPath(FileViewer.DIR+FileViewer.getIconName(value.filename))).appendTo(li);var name='<span class="nameDiv">'+value.filename+"</span>";var size='<span class="sizeDiv">&nbsp;('+FileViewer.getSize(value.size)+")</span>";var titleA=$("<a>").addClass("fileName").attr("title",value.filename).html(name+size).appendTo(li);this.manageAnchor(titleA,value);var saveA=$("<a>").addClass("save").text(JSV.getLang("FileViewer","save")).appendTo(li);this.manageAnchor(saveA,value);$("<span>").addClass("block").text("| ").appendTo(li);var editA=$("<a>").addClass("edit").text(JSV.getLang("ContentViewer","edit")).appendTo(li);editA.on("click",value,function(e){$this.openFileManager(e.data)});$("<span>").addClass("block").text("| ").appendTo(li);var delA=$("<a>").addClass("del").text(JSV.getLang("ContentViewer","del")).appendTo(li);delA.on("click",value,function(e){if(confirm(JSV.getLang("PortalManager","doDelete"))){$.ajax({url:JSV.getContextPath($this.removeUrl),dataType:"json",data:{id:e.data.gid,},async:false,type:"POST",success:function(data){if(data.error){$this.onError(data);return}if(data!=null){$this.setValue(eval($this.dataName))}},error:function(xhr){}})}})};CardFileViewer.prototype.openFileManager=function(i){var g=this;var b=$("body");if($(b).find(".fixedCardLayer").length>0){$(b).find(".fixedCardLayer").remove()}var e=$("<div></div>").addClass("fixedCardLayer");e.appendTo(b);e.css({position:"absolute",top:"0",left:"0",width:"100%"});e.height(b.height());var d=$("<div>").addClass("subfixedBg").appendTo(e);d.css({"z-index":"111","background-color":"#b9b9b9"});this.layerDiv=$("<div>").addClass("subfixedLayerArea").appendTo(e);this.layerDiv.css("z-index","112");this.layerDiv.appendTo(e);this.layerDiv.resize(function(k){g.resize()});$(window).resize(function(k){g.resize()});var h=$("<div>").addClass("subfixedTaskLayerHeader");h.appendTo(this.layerDiv);$("<h1>").addClass("layerTitle").text(JSV.getLang("CardFileViewer","fileTitle")).appendTo(h);var f=$("<div>",{id:"subTaskContent"}).addClass("subfixedTaskLayerContent");f.css("width","630px");f.css("height","330px");f.appendTo(this.layerDiv);g.layerWidget=$(f).get(0);var j=$("<span>").addClass("subfixedLayerClose");j.appendTo(h);j.click(function(){$(".fixedCardLayer",document).hide()});var a=f;var c="PORTLET_ID="+CardFileViewer.UPLOAD_PTLID;setTimeout(function(){a.load(JSV.getContextPath(g.style.vrsnUrl,c),{id:g.cardId,fileId:i.id,size:i.size,filename:i.filename,vrsn:i.vrsnNum})},2)};CardFileViewer.prototype.resize=function(){var a=$(window).width()/2;var b=$(this.layerDiv).width()/2;$(this.layerDiv).css("left",(a-b)+"px");$(this.layerDiv).css("top",$(window).scrollTop()+200)};CardFileViewer.prototype.manageAnchor=function(b,d){var c=JSV.getContextPath(JSV.merge(this.attachUrl,d));if(JSV.browser.msie){b.click(function(){c+="&isFF=true";b.attr("href",c)})}else{if(JSV.browser.firefox){c+="&isFF=true"}b.attr("href",c)}};CardFileViewer.prototype.selectHandler=function(b){for(var a=0;a<b.length;a++){b[a].id=this.fileSeqId++;this.sendFile(b[a],a,b.length)}};CardFileViewer.prototype.sendFile=function sendFile(file,idx,fileLength){var _this=this;var fileItem={method:"editor",type:1,path:"com.kcube.jsv.file.",filename:file.name,size:file.size};this.fileCount++;var formData=new FormData();formData.append("upload",JSV.toJSON(fileItem));formData.append("com.kcube.jsv.file.",file);var tr=this.addProgress(file,file.id);var successCallback=function(file){var obj=new Object();obj.id=_this.cardId;obj.attachments=[file];$.ajax({url:JSV.getContextPath(_this.registerUrl),dataType:"json",data:{item:JSV.toJSON(obj),method:"add"},async:false,type:"POST",success:function(data){if(data.error){_this.onError(data);return}if(data!=null){_this.setValue(eval(_this.dataName))}},error:function(xhr){}})};var fileResponse=null;$.ajax({xhr:function(){var xhrobj=$.ajaxSettings.xhr();_this.xhrObjs[file.id]=xhrobj;xhrobj.upload.addEventListener("progress",function(e){var nPerc=0;var position=e.loaded||e.position;var total=e.total;if(e.lengthComputable){nPerc=Math.ceil(position/total*100)}_this.setProgress(tr,nPerc)},false);return xhrobj},url:JSV.getContextPath(FileUploadObject.UPLOAD_URL),dataType:"html",data:formData,cache:false,contentType:false,processData:false,type:"POST",success:function(data){_this.xhrObjs[file.id]=null;_this.setProgress(tr,100);if(++_this.count==_this.fileCount){_this.count=0;_this.fileCount=0;_this.dialogClose()}var results=data.split("|");fileResponse={method:"editor",type:results[0],path:results[1],filename:file.name,size:file.size};successCallback(fileResponse)}})};CardFileViewer.prototype.initDialog=function(){this.dialogDiv=$('<div class="layerFileupLoad">		<div class="fileUploadList">			<table border="0" cellspacing="0" cellpadding="0" id="fileUploadTable">				<colgroup>					<col width="251"/>					<col width="89"/>					<col width="*"/>				</colgroup>				<tr>					<th>'+JSV.getLang("DocFileViewer","fileName")+"</th>					<th>"+JSV.getLang("DocFileViewer","fileSize")+"</th>					<th>"+JSV.getLang("DocFileViewer","fileUploadStatus")+'</th>				</tr>				<tr style="height:7px;">				</tr>			</table>		</div>	</div>').attr({title:JSV.getLang("DocFileViewer","fileUpload"),id:"fileUploadDialog"+this.seq}).appendTo(this.widget);var a=this;this.fileDialog=$("#fileUploadDialog"+this.seq).dialog({width:560,height:350,modal:true,resizable:false,autoOpen:false,dialogClass:"CardFileViewer LayerModalDialog FileModal",beforeClose:function(c){for(var b in a.xhrObjs){if(a.xhrObjs.hasOwnProperty(b)&&a.xhrObjs[b]){a.xhrObjs[b].abort()}}a.count=0;a.fileCount=0;$("#fileUploadTable tr.uploadTr").remove()}})};CardFileViewer.prototype.dialogOpen=function(){this.fileDialog.dialog("open")};CardFileViewer.prototype.dialogClose=function(){this.fileDialog.dialog("close")};CardFileViewer.prototype.addProgress=function(c,e){if(!this.fileDialog.dialog("isOpen")){this.dialogOpen()}var d=$("<tr>").addClass("uploadTr").appendTo(this.dialogDiv.find("#fileUploadTable"));$("<td>").addClass("fileName").html('<img src="'+JSV.getContextPath(FileViewer.DIR+FileViewer.getIconName(c.name))+'"/>'+c.name).appendTo(d);$("<td>").addClass("fileSize").html(FileViewer.getSize(c.size)).appendTo(d);var b=$("<td>").addClass("status").appendTo(d);var a=$("<div>").addClass("progress").appendTo(b);$("<div>").addClass("percent").width(0).html("&nbsp;").appendTo(a);$("<span>").addClass("statusText").appendTo(b);if(e){d.attr("id","fileUpdTr"+e)}return d};CardFileViewer.prototype.setProgress=function(c,a){var b=c.find("div.percent");b.width(a+"%");if(a==100){b.addClass("done")}c.find("span.statusText").text(a==100?JSV.getLang("DocFileViewer","complete"):a+"%")};CardFileViewer.prototype.onError=function(a){if(a.error.indexOf("CardUploadDeniedException")>-1){alert(JSV.getLang("DocFileViewer","uploadDenied"))}else{if(a.error.indexOf("DrmFilePermissionDenied")>-1){alert(JSV.getLang("DocFileViewer","addFileDrmError"))}else{alert(JSV.getLang("DocFileViewer","addError"))}}};CardFileViewer.UPLOAD_PTLID="CARD_FILE_UPLOAD";function CardOpenEditor(b,a){this.parent=b;this.style=a||{};this.callback=this.style.callback;this.url=this.style.url||"usr.card.edit.jsp?id=";this.className=this.style.className||"CardOpenEditor"}CardOpenEditor.prototype.setValue=function(f){var g=this;if($(this.parent).find(".CardOpenEditor").length>0){$(this.parent).find(".CardOpenEditor").remove()}var a=$("<div></div>").addClass("CardOpenEditor");a.appendTo(this.parent);a.height(this.parent.height());var d=$("<div>").addClass("CardOpenEditorBg").css("z-index","10").appendTo(a);this.layerDiv=$("<div>").addClass("cardLayer card-detail").attr("id","CardOpenLayer").appendTo(a);this.layerDiv.data("CardOpenEditor",this);this.layerDiv.resize(function(h){g.resize()});$(window).resize(function(h){g.resize()});var c=this.url+f;var b=CardOpenEditor.CARDOPEN_PTLID+"_"+JSV.SEQUENCE++;var e="PORTLET_ID="+b;setTimeout(function(){g.layerDiv.load(JSV.getContextPath(JSV.getModuleUrl(c),e),function(i,h,j){})},2);d.on("click",function(){$("#layer"+b).slimScroll({destroy:true});$("body").find(".CardOpenEditor").hide()})};CardOpenEditor.prototype.resize=function(){var a=$(window).width()/2;var b=$(this.layerDiv).width()/2;$(this.layerDiv).css("left",(a-b)+"px");$(this.layerDiv).css("top",$(window).scrollTop()+200)};CardOpenEditor.CARDOPEN_PTLID="CARDOPEN";